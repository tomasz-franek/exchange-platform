<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">
  <changeSet id="script-2025-05-03-exchange_user" author="tf">
    <comment>Create 'exchange_user' table</comment>
    <createTable tableName="exchange_user" schemaName="${schemaName}">
      <column name="id" type="UUID">
        <constraints primaryKey="true" primaryKeyName="user_pk" referencedColumnNames="id"/>
      </column>
      <column name="email" type="VARCHAR(256)">
        <constraints nullable="false"/>
      </column>
      <column name="status" type="VARCHAR(20)">
        <constraints nullable="false"/>
      </column>
      <column name="created_date_utc" type="TIMESTAMP WITHOUT TIME ZONE">
        <constraints nullable="false"/>
      </column>
      <column name="modified_date_utc" type="TIMESTAMP WITHOUT TIME ZONE">
      </column>
      <column name="modified_by" type="VARCHAR(100)">
      </column>
      <column name="version" type="integer">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  <changeSet id="script-2025-06-18-currency" author="tf">
    <comment>Create 'currency' table</comment>
    <createTable tableName="currency" schemaName="${schemaName}">
      <column name="id" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="currency_pk" referencedColumnNames="id"/>
      </column>
      <column name="code" type="VARCHAR(3)">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="integer">
        <constraints nullable="false"/>
      </column>
      <column name="minimum_exchange" type="BIGINT">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <createSequence sequenceName="currency_seq"
      startValue="1"
      incrementBy="1"
      schemaName="${schemaName}"/>
    <addUniqueConstraint tableName="currency" columnNames="code" schemaName="${schemaName}"/>
  </changeSet>
  <changeSet id="script-2025-06-18-user_account" author="tf">
    <comment>Create 'user_account' table</comment>
    <createTable tableName="user_account" schemaName="${schemaName}">
      <column name="id" type="UUID">
        <constraints primaryKey="true" primaryKeyName="user_account_pk" referencedColumnNames="id"/>
      </column>
      <column name="currency_id" type="BIGINT">
        <constraints foreignKeyName="fk_user_account_currency"
          referencedTableName="currency"
          referencedColumnNames="id"
          referencedTableSchemaName="${schemaName}"
          nullable="false"
        />
      </column>
      <column name="user_id" type="UUID">
        <constraints foreignKeyName="fk_user_account_user"
          referencedTableName="exchange_user"
          referencedColumnNames="id"
          referencedTableSchemaName="${schemaName}"
          nullable="false"
        />
      </column>
      <column name="version" type="integer">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addUniqueConstraint tableName="user_account" columnNames="currency_id,user_id"
      schemaName="${schemaName}"/>
  </changeSet>
  <changeSet id="script-2025-06-18-exchange_event" author="tf">
    <comment>Create 'exchange_event' table</comment>
    <createTable tableName="exchange_event" schemaName="${schemaName}">
      <column name="id" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="exchange_event_pk"
          referencedColumnNames="id"/>
      </column>
      <column name="pair" type="VARCHAR(7)">
        <constraints nullable="false"/>
      </column>
      <column name="direction" type="VARCHAR(1)">
        <constraints nullable="false" checkConstraint="direction in ('B','S')"/>
      </column>
      <column name="date_utc" type="TIMESTAMP WITHOUT TIME ZONE">
        <constraints nullable="false"/>
      </column>
      <column name="event_type" type="VARCHAR(20)">
        <constraints nullable="false"/>
      </column>
      <column name="user_id" type="UUID">
        <constraints nullable="false"
          foreignKeyName="fk_exchange_event_user"
          referencedTableName="exchange_user"
          referencedColumnNames="id"
          referencedTableSchemaName="${schemaName}"
        />
      </column>
      <column name="user_account_id" type="UUID">
        <constraints nullable="false"
          foreignKeyName="fk_exchange_event_user_account"
          referencedTableName="user_account"
          referencedColumnNames="id"
          referencedTableSchemaName="${schemaName}"
        />
      </column>
      <column name="amount" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="ratio" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="integer">
        <constraints nullable="false"/>
      </column>
      <column name="ticket_status" type="VARCHAR(20)">
        <constraints nullable="false"/>
      </column>
      <column name="modified_date_utc" type="TIMESTAMP WITHOUT TIME ZONE"/>
    </createTable>
    <createSequence sequenceName="exchange_event_seq"
      startValue="1"
      incrementBy="500"
      schemaName="${schemaName}"/>
  </changeSet>
  <changeSet id="script-2025-06-18-exchange_event_source" author="tf">
    <comment>Create 'exchange_event_source' table</comment>
    <createTable tableName="exchange_event_source" schemaName="${schemaName}">
      <column name="id" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="exchange_event_source_pk" nullable="false"
          referencedColumnNames="id"/>
      </column>
      <column name="user_account_id" type="UUID">
        <constraints nullable="false"
          foreignKeyName="fk_exchange_event_source_user_account"
          referencedTableName="user_account"
          referencedColumnNames="id"
          referencedTableSchemaName="${schemaName}"
        />
      </column>
      <column name="date_utc" type="TIMESTAMP WITHOUT TIME ZONE">
        <constraints nullable="false"/>
      </column>
      <column name="event_type" type="VARCHAR(20)">
        <constraints nullable="false"/>
      </column>
      <column name="amount" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="created_by" type="UUID">
        <constraints nullable="false"/>
      </column>
      <column name="created_date_utc" type="TIMESTAMP WITHOUT TIME ZONE">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <createSequence sequenceName="exchange_event_source_seq"
      startValue="1"
      incrementBy="500"
      schemaName="${schemaName}"/>
  </changeSet>
  <changeSet id="script-2025-06-18-system_snapshot" author="tf">
    <comment>Create 'system_snapshot' table</comment>
    <createTable tableName="system_snapshot" schemaName="${schemaName}">
      <column name="id" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="system_snapshot_pk" nullable="false"
          referencedColumnNames="id"/>
      </column>
      <column name="date_utc" type="DATE">
        <constraints nullable="false"/>
      </column>
      <column name="last_event_source_id" type="BIGINT"/>
      <column name="version" type="integer">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <createSequence sequenceName="system_snapshot_seq"
      startValue="1"
      incrementBy="1"
      schemaName="${schemaName}"/>
  </changeSet>
  <changeSet id="script-2025-06-18-snapshot_data" author="tf">
    <comment>Create 'snapshot_data' table</comment>
    <createTable tableName="snapshot_data" schemaName="${schemaName}">
      <column name="id" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="snapshot_data_pk" nullable="false"
          referencedColumnNames="id"/>
      </column>
      <column name="system_snapshot_id" type="BIGINT">
        <constraints nullable="false"
          foreignKeyName="fk_snapshot_data_system_snapshot"
          referencedTableName="system_snapshot"
          referencedColumnNames="id"
          referencedTableSchemaName="${schemaName}"/>
      </column>
      <column name="user_account_id" type="UUID">
        <constraints nullable="false"
          foreignKeyName="fk_snapshot_data_user_account"
          referencedTableName="user_account"
          referencedColumnNames="id"
          referencedTableSchemaName="${schemaName}"
        />
      </column>
      <column name="amount" type="BIGINT">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <createSequence sequenceName="snapshot_data_seq"
      startValue="1"
      incrementBy="500"
      schemaName="${schemaName}"/>
  </changeSet>
  <changeSet id="script-2025-06-18-user_property" author="tf">
    <comment>Create 'user_property' table</comment>
    <createTable tableName="user_property" schemaName="${schemaName}">
      <column name="user_id" type="UUID">
        <constraints nullable="false"
          foreignKeyName="fk_user_property_user"
          primaryKey="true"
          referencedTableName="exchange_user"
          referencedColumnNames="id"
          referencedTableSchemaName="${schemaName}"/>
      </column>
      <column name="unicode_locale" type="VARCHAR(5)" defaultValue="EN">
        <constraints nullable="false"/>
      </column>
      <column name="language" type="VARCHAR(5)" defaultValue="EN">
        <constraints nullable="false"/>
      </column>
      <column name="timezone" type="VARCHAR(30)" defaultValue="UTC">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="integer">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  <changeSet id="script-2025-06-24-exchange_event_source" author="tf">
    <comment>Grant insert only for table exchange_event_source</comment>
    <sql dbms="postgresql">
      REVOKE ALL ON TABLE ${schemaName}.exchange_event_source FROM PUBLIC;
    </sql>
    <sql dbms="postgresql">
      REVOKE DELETE, TRUNCATE, TRIGGER, REFERENCES, UPDATE ON TABLE
      ${schemaName}.exchange_event_source FROM exchange;
    </sql>
  </changeSet>
  <changeSet id="script-2025-07-16-system_message" author="tf">
    <comment>System messages</comment>
    <createTable tableName="system_message" schemaName="${schemaName}">
      <column name="id" type="UUID"/>
      <column name="create_date_utc" type="TIMESTAMP WITHOUT TIME ZONE">
        <constraints nullable="false"/>
      </column>
      <column name="message_text" type="VARCHAR(400)">
        <constraints nullable="false"/>
      </column>
      <column name="active" type="boolean">
        <constraints nullable="false"/>
      </column>
      <column name="priority" type="SMALLINT">
        <constraints nullable="false"/>
      </column>
      <column name="version" type="integer">
        <constraints nullable="false"/>
      </column>
      <column name="date_from_utc" type="TIMESTAMP WITHOUT TIME ZONE"/>
      <column name="date_to_utc" type="TIMESTAMP WITHOUT TIME ZONE"/>
    </createTable>
  </changeSet>
  <changeSet id="script-2025-07-24-exchange_event_source" author="tf">
    <comment>Checksum for exchange_event_source</comment>
    <addColumn tableName="exchange_event_source" schemaName="${schemaName}">
      <column name="checksum" type="BIGINT">
        <constraints nullable="false"/>
      </column>
    </addColumn>
  </changeSet>
  <changeSet id="script-2025-07-30-exchange_event" author="tf">
    <comment>Column amount_realized for table exchange_event</comment>
    <addColumn tableName="exchange_event" schemaName="${schemaName}">
      <column name="amount_realized" type="BIGINT" defaultValueNumeric="0">
        <constraints nullable="false"/>
      </column>
    </addColumn>
  </changeSet>
  <changeSet id="script-2025-08-07-address" author="tf">
    <comment>Table address</comment>
    <createTable tableName="address" schemaName="${schemaName}">
      <column name="id" type="UUID">
        <constraints primaryKey="true" primaryKeyName="address_pk" referencedColumnNames="id"/>
      </column>
      <column name="user_id" type="UUID">
        <constraints foreignKeyName="fk_address_user"
          referencedTableName="exchange_user"
          referencedColumnNames="id"
          referencedTableSchemaName="${schemaName}"
          nullable="false"
        />
      </column>
      <column name="name" type="VARCHAR(500)">
        <constraints nullable="false"/>
      </column>
      <column name="country" type="VARCHAR(2)">
        <constraints nullable="false"/>
      </column>
      <column name="street" type="VARCHAR(70)"/>
      <column name="city" type="VARCHAR(70)"/>
      <column name="zip_code" type="VARCHAR(10)"/>
      <column name="tax_id" type="VARCHAR(20)"/>
      <column name="vat_id" type="VARCHAR(20)"/>
      <column name="phone" type="VARCHAR(20)"/>
      <column name="version" type="integer">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>
  <changeSet id="script-2025-08-12-exchange_event_source" author="tf">
    <comment>Columns event_id in table exchange_event_source</comment>
    <addColumn tableName="exchange_event_source" schemaName="${schemaName}">
      <column name="currency" type="VARCHAR(3)">
        <constraints nullable="false"/>
      </column>
      <column name="event_id" type="BIGINT"/>
      <column name="reverse_event_id" type="BIGINT"/>
      <column name="ratio" type="BIGINT"/>
      <column name="reverse_amount" type="BIGINT"/>
    </addColumn>
    <addForeignKeyConstraint
      baseTableName="exchange_event_source"
      baseColumnNames="event_id"
      constraintName="fk_exchange_event_source_exchange_event"
      referencedTableName="exchange_event"
      referencedColumnNames="id"
      referencedTableSchemaName="${schemaName}"
      baseTableSchemaName="${schemaName}"
    />
    <addForeignKeyConstraint
      baseTableName="exchange_event_source"
      baseColumnNames="reverse_event_id"
      constraintName="fk_exchange_event_source_reverse_exchange_event"
      referencedTableName="exchange_event"
      referencedColumnNames="id"
      referencedTableSchemaName="${schemaName}"
      baseTableSchemaName="${schemaName}"
    />
  </changeSet>
  <changeSet id="script-2025-08-18-system-address" author="tf">
    <comment>Initial system data</comment>
    <insert tableName="exchange_user" schemaName="${schemaName}">
      <column name="id" value="8d8a228a-19a4-4f71-9f69-5dd0a291f8c0"/>
      <column name="email" value="system@"/>
      <column name="status" value="ACTIVE"/>
      <column name="created_date_utc" value="now()"/>
      <column name="version" value="0"/>
    </insert>
    <insert schemaName="${schemaName}" tableName="address">
      <column name="id" value="67eaca3e-c09d-4c82-bb42-e2ca60c333ad"/>
      <column name="user_id" value="8d8a228a-19a4-4f71-9f69-5dd0a291f8c0"/>
      <column name="name" value="Exchange Platform LTD"/>
      <column name="country" value="UK"/>
      <column name="city" value="London"/>
      <column name="street" value="Street Road 11"/>
      <column name="zip_code" value="AA 000"/>
      <column name="phone" value="+44 00 0000 0000"/>
      <column name="vat_id" value="GB 0000000000"/>
      <column name="tax_id" value="GB 0000000000"/>
      <column name="version" value="0"/>
    </insert>
  </changeSet>
  <changeSet id="script-2025-08-18-currencies" author="tf">
    <comment>Initial currencies values</comment>
    <insert tableName="currency" schemaName="${schemaName}">
      <column name="id" valueComputed="nextval('${schemaName}.currency_seq')"/>
      <column name="code" value="PLN"/>
      <column name="version" value="0"/>
      <column name="minimum_exchange" value="5"/>
    </insert>
    <insert tableName="currency" schemaName="${schemaName}">
      <column name="id" valueComputed="nextval('${schemaName}.currency_seq')"/>
      <column name="code" value="EUR"/>
      <column name="version" value="0"/>
      <column name="minimum_exchange" value="5"/>
    </insert>
    <insert tableName="currency" schemaName="${schemaName}">
      <column name="id" valueComputed="nextval('${schemaName}.currency_seq')"/>
      <column name="code" value="GBP"/>
      <column name="version" value="0"/>
      <column name="minimum_exchange" value="5"/>
    </insert>
    <insert tableName="currency" schemaName="${schemaName}">
      <column name="id" valueComputed="nextval('${schemaName}.currency_seq')"/>
      <column name="code" value="CHF"/>
      <column name="version" value="0"/>
      <column name="minimum_exchange" value="5"/>
    </insert>
    <insert tableName="currency" schemaName="${schemaName}">
      <column name="id" valueComputed="nextval('${schemaName}.currency_seq')"/>
      <column name="code" value="USD"/>
      <column name="version" value="0"/>
      <column name="minimum_exchange" value="5"/>
    </insert>
  </changeSet>
  <changeSet id="script-2025-08-18-system-accounts" author="tf">
    <comment>System accounts</comment>
    <insert tableName="user_account" schemaName="${schemaName}">
      <column name="id" value="8d8a228a-19a4-4f71-9f69-000000000001"/>
      <column name="user_id" value="8d8a228a-19a4-4f71-9f69-5dd0a291f8c0"/>
      <column name="currency_id" value="1"/>
      <column name="version" value="0"/>
    </insert>
    <insert tableName="user_account" schemaName="${schemaName}">
      <column name="id" value="8d8a228a-19a4-4f71-9f69-000000000002"/>
      <column name="user_id" value="8d8a228a-19a4-4f71-9f69-5dd0a291f8c0"/>
      <column name="currency_id" value="2"/>
      <column name="version" value="0"/>
    </insert>
    <insert tableName="user_account" schemaName="${schemaName}">
      <column name="id" value="8d8a228a-19a4-4f71-9f69-000000000003"/>
      <column name="user_id" value="8d8a228a-19a4-4f71-9f69-5dd0a291f8c0"/>
      <column name="currency_id" value="3"/>
      <column name="version" value="0"/>
    </insert>
    <insert tableName="user_account" schemaName="${schemaName}">
      <column name="id" value="8d8a228a-19a4-4f71-9f69-000000000004"/>
      <column name="user_id" value="8d8a228a-19a4-4f71-9f69-5dd0a291f8c0"/>
      <column name="currency_id" value="4"/>
      <column name="version" value="0"/>
    </insert>
    <insert tableName="user_account" schemaName="${schemaName}">
      <column name="id" value="8d8a228a-19a4-4f71-9f69-000000000005"/>
      <column name="user_id" value="8d8a228a-19a4-4f71-9f69-5dd0a291f8c0"/>
      <column name="currency_id" value="5"/>
      <column name="version" value="0"/>
    </insert>
  </changeSet>
  <changeSet id="script-2025-08-27-exchange-accounts" author="tf">
    <comment>Exchange accounts</comment>
    <insert tableName="exchange_user" schemaName="${schemaName}">
      <column name="id" value="921467e9-6fde-46e7-a329-06288db72f5d"/>
      <column name="email" value="exchange_platform@"/>
      <column name="status" value="ACTIVE"/>
      <column name="created_date_utc" value="now()"/>
      <column name="version" value="0"/>
    </insert>
    <insert tableName="user_account" schemaName="${schemaName}">
      <column name="id" value="921467e9-6fde-46e7-a329-000000000001"/>
      <column name="user_id" value="921467e9-6fde-46e7-a329-06288db72f5d"/>
      <column name="currency_id" value="1"/>
      <column name="version" value="0"/>
    </insert>
    <insert tableName="user_account" schemaName="${schemaName}">
      <column name="id" value="921467e9-6fde-46e7-a329-000000000002"/>
      <column name="user_id" value="921467e9-6fde-46e7-a329-06288db72f5d"/>
      <column name="currency_id" value="2"/>
      <column name="version" value="0"/>
    </insert>
    <insert tableName="user_account" schemaName="${schemaName}">
      <column name="id" value="921467e9-6fde-46e7-a329-000000000003"/>
      <column name="user_id" value="921467e9-6fde-46e7-a329-06288db72f5d"/>
      <column name="currency_id" value="3"/>
      <column name="version" value="0"/>
    </insert>
    <insert tableName="user_account" schemaName="${schemaName}">
      <column name="id" value="921467e9-6fde-46e7-a329-000000000004"/>
      <column name="user_id" value="921467e9-6fde-46e7-a329-06288db72f5d"/>
      <column name="currency_id" value="4"/>
      <column name="version" value="0"/>
    </insert>
    <insert tableName="user_account" schemaName="${schemaName}">
      <column name="id" value="921467e9-6fde-46e7-a329-000000000005"/>
      <column name="user_id" value="921467e9-6fde-46e7-a329-06288db72f5d"/>
      <column name="currency_id" value="5"/>
      <column name="version" value="0"/>
    </insert>
  </changeSet>
  <changeSet id="script-2025-10-26-user-bank-account" author="tf">
    <comment>Create 'user_bank_account' table</comment>
    <createTable tableName="user_bank_account" schemaName="${schemaName}">
      <column name="id" type="UUID">
        <constraints primaryKey="true" primaryKeyName="user_bank_account_pk"
          referencedColumnNames="id"/>
      </column>
      <column name="user_account_id" type="UUID">
        <constraints
          foreignKeyName="fk_user_bank_account_user_account_id"
          referencedTableName="user_account"
          referencedColumnNames="id"
          referencedTableSchemaName="${schemaName}"
          nullable="false"
        />
      </column>
      <column name="account_number" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="country" type="VARCHAR(2)">
        <constraints nullable="false"/>
      </column>
      <column name="created_date_utc" type="TIMESTAMP WITHOUT TIME ZONE">
        <constraints nullable="false"/>
      </column>
      <column name="created_by" type="VARCHAR(100)">
        <constraints nullable="false"/>
      </column>
      <column name="modified_date_utc" type="TIMESTAMP WITHOUT TIME ZONE"/>
      <column name="modified_by" type="VARCHAR(100)"/>
      <column name="verified_date_utc" type="TIMESTAMP WITHOUT TIME ZONE"/>
      <column name="verified_by" type="VARCHAR(100)"/>
      <column name="version" type="integer">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <createSequence sequenceName="user_bank_account_seq"
      startValue="1"
      incrementBy="1"
      schemaName="${schemaName}"/>
  </changeSet>
  <changeSet id="script-2026-01-25-withdraw-config" author="tf">
    <comment>Create 'withdraw' table</comment>
    <createTable tableName="withdraw" schemaName="${schemaName}">
      <column name="id" type="BIGINT">
        <constraints primaryKey="true" primaryKeyName="withdraw_pk"
          referencedColumnNames="id"/>
      </column>
      <column name="currency_id" type="BIGINT">
        <constraints
          foreignKeyName="fk_withdraw_currency_id"
          referencedTableName="currency"
          referencedColumnNames="id"
          referencedTableSchemaName="${schemaName}"
          nullable="false"
        />
      </column>
      <column name="amount" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="created_date_utc" type="TIMESTAMP WITHOUT TIME ZONE">
        <constraints nullable="false"/>
      </column>
      <column name="created_by" type="UUID">
        <constraints nullable="false"/>
      </column>
      <column name="modified_date_utc" type="TIMESTAMP WITHOUT TIME ZONE"/>
      <column name="modified_by" type="UUID"/>
      <column name="version" type="integer">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <createSequence sequenceName="withdraw_seq"
      startValue="1"
      incrementBy="1"
      schemaName="${schemaName}"/>
  </changeSet>
</databaseChangeLog>